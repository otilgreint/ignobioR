baseline_records <- floristic_initial_subset
# 3. IDENTIFY TRULY NEW RECORDS
# Create unique IDs for Initial data
initial_ids <- paste(floristic_initial$Taxon,
round(floristic_initial$Lat, 6),
round(floristic_initial$Long, 6),
floristic_initial$year, sep = "_")
# Create unique IDs for Updated data
updated_ids <- paste(floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year, sep = "_")
# Find IDs that exist in Updated but NOT in Initial
new_record_ids <- setdiff(updated_ids, initial_ids)
# Extract those full records
new_records <- floristic_updated[paste(floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year, sep = "_") %in% new_record_ids, ]
# 4. APPLY GEOGRAPHIC BIAS
# Only keep new records BELOW the latitude threshold
biased_new_records <- new_records %>%
dplyr::filter(Lat < lat_threshold)
# 5. COMBINE
# Updated Biased = Full Original Baseline + Only Southern New Records
floristic_updated_biased <- rbind(
baseline_records,
biased_new_records
)
# ============================================================================
# VERIFICATION OUTPUTS
# ============================================================================
cat("=== GEOGRAPHIC BIAS SIMULATION ===\n")
cat("Latitude threshold:", lat_threshold, "°N\n")
cat("Total NEW records available:", nrow(new_records), "\n")
cat("New records KEPT (South):", nrow(biased_new_records), "\n")
cat("New records EXCLUDED (North):", nrow(new_records) - nrow(biased_new_records), "\n")
comparison_biased <- compare_mrfi(
data_flor_initial = floristic_initial_subset,
data_flor_updated = floristic_updated_biased,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_BIASED_SOUTH"
)
# ============================================================================
# CREATE GEOGRAPHICALLY BIASED SUBSET FOR TESTING
# ============================================================================
# 1. BASELINE: Use FULL initial dataset (Matches "as they are")
floristic_initial_subset <- floristic_initial
# 2. DEFINITIONS
lat_threshold <- 43.634
baseline_records <- floristic_initial_subset
# 3. IDENTIFY TRULY NEW RECORDS
# Create unique IDs for Initial data
initial_ids <- paste(floristic_initial$Taxon,
round(floristic_initial$Lat, 6),
round(floristic_initial$Long, 6),
floristic_initial$year, sep = "_")
# Create unique IDs for Updated data
updated_ids <- paste(floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year, sep = "_")
# Find IDs that exist in Updated but NOT in Initial
new_record_ids <- setdiff(updated_ids, initial_ids)
# Extract those full records
new_records <- floristic_updated[paste(floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year, sep = "_") %in% new_record_ids, ]
# 4. APPLY GEOGRAPHIC BIAS
# Only keep new records BELOW the latitude threshold
biased_new_records <- new_records %>%
dplyr::filter(Lat > lat_threshold)
# 5. COMBINE
# Updated Biased = Full Original Baseline + Only Southern New Records
floristic_updated_biased <- rbind(
baseline_records,
biased_new_records
)
# ============================================================================
# VERIFICATION OUTPUTS
# ============================================================================
cat("=== GEOGRAPHIC BIAS SIMULATION ===\n")
cat("Latitude threshold:", lat_threshold, "°N\n")
cat("Total NEW records available:", nrow(new_records), "\n")
cat("New records KEPT (South):", nrow(biased_new_records), "\n")
cat("New records EXCLUDED (North):", nrow(new_records) - nrow(biased_new_records), "\n")
comparison_biased <- compare_mrfi(
data_flor_initial = floristic_initial_subset,
data_flor_updated = floristic_updated_biased,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_BIASED_SOUTH-2"
)
# Run this line once if you haven't installed ggforce before
install.packages("ggforce")
source("~/R projects/ignobioR/R/compare_mrfi.R", echo = TRUE)
comparison_biased <- compare_mrfi(
data_flor_initial = floristic_initial_subset,
data_flor_updated = floristic_updated_biased,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_BIASED_SOUTH-2"
)
# ============================================================================
# EVALUATE RESULTS
# ============================================================================
cat("\n=== EXPECTED RESULTS WITH SOUTHERN BIAS ===\n")
cat("Should see:\n")
cat("  - GREEN quadrant (Q4 improved): Southern high-IRFI cells\n")
cat("  - RED quadrant (Q4 not improved): Northern high-IRFI cells\n")
cat("  - Correlation near zero or negative: Sampling didn't prioritize ignorance\n\n")
print(comparison_biased$summary[comparison_biased$summary$Statistic %in%
c("Correlation (IRFI vs delta)",
"Mean IRFI reduction (%)",
"Cells improved (%)",
"Cells worsened (%)"), ])
cat("\n")
print(comparison_biased$quadrant_analysis)
library(sf)
library(dplyr)
# ============================================================================
# LOAD BOTH DATASETS
# ============================================================================
# 2024 situation (baseline - before your fieldwork)
floristic_ante_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/progetti/MSRM/wiki parco/01_dec_2025-ante.shp")
# 2025 situation (updated - including your fieldwork)
floristic_2025_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/progetti/MSRM/wiki parco/01_dec_2025-post_BIAS.shp")
# ============================================================================
# CLEAN AND RENAME BOTH DATASETS
# ============================================================================
# Function to clean and rename (DRY principle)
clean_floristic <- function(data) {
data %>%
rename(
Taxon = Sub.Repert,
Lat = Latitudine,
Long = Longitudin,
uncertainty = Accuratezz,
year = Anno.Reper
) %>%
filter(
!is.na(Taxon),
!is.na(Lat),
!is.na(Long),
!is.na(uncertainty),
!is.na(year)
)
}
# Apply cleaning to both
floristic_initial <- clean_floristic(floristic_ante_raw)
floristic_updated <- clean_floristic(floristic_2025_raw)
library(sf)
library(dplyr)
# ============================================================================
# LOAD DATA WITH NEW STANDARDIZED NOMENCLATURE
# ============================================================================
# Baseline (before 2025 fieldwork)
floristic_ante_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/Progetti/MSRM/wiki parco/01_dec_2025-ante.shp")
# Updated (after 2025 fieldwork)
floristic_post_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/Progetti/MSRM/wiki parco/01_dec_2025-post_BIAS.shp")
# Study area (same as before)
study_area <- st_read("C:/Users/Giuseppe Antonelli/Documents/progetti/MSRM/test-na/confini-buffer125_finale.shp")
if (is.na(st_crs(study_area))) {
st_crs(study_area) <- 4326
}
# ============================================================================
# CLEAN AND RENAME WITH NEW COLUMN NAMES
# ============================================================================
clean_floristic_new <- function(data) {
data %>%
rename(
uncertainty = Accuratezz,
year = Anno.Reper,  # Note: might be Anno_Reper depending on shapefile
Lat = Lat.Wgs84,
Long = Lon.Wgs84,
Taxon = Combinatio
) %>%
filter(
!is.na(Taxon),
!is.na(Lat),
!is.na(Long),
!is.na(uncertainty),
!is.na(year)
)
}
# Check actual column names first
cat("Checking column names in ante file:\n")
print(names(floristic_ante_raw))
cat("\nChecking column names in post file:\n")
print(names(floristic_post_raw))
# Apply cleaning (adjust column names based on output above if needed)
floristic_initial <- clean_floristic_new(floristic_ante_raw)
floristic_updated <- clean_floristic_new(floristic_post_raw)
# ============================================================================
# SUMMARY OF STANDARDIZED DATA
# ============================================================================
cat("\n=== STANDARDIZED DATA SUMMARY ===\n\n")
cat("BASELINE (ante - before 2025):\n")
cat("  Total records:", nrow(floristic_initial), "\n")
cat("  Unique taxa:", length(unique(floristic_initial$Taxon)), "\n")
cat("  Year range:", range(floristic_initial$year), "\n\n")
cat("UPDATED (post - after 2025):\n")
cat("  Total records:", nrow(floristic_updated), "\n")
cat("  Unique taxa:", length(unique(floristic_updated$Taxon)), "\n")
cat("  Year range:", range(floristic_updated$year), "\n\n")
cat("CHANGES:\n")
cat("  New observations added:", nrow(floristic_updated) - nrow(floristic_initial), "\n")
# Check for truly new taxa
taxa_initial <- unique(floristic_initial$Taxon)
taxa_updated <- unique(floristic_updated$Taxon)
new_taxa <- setdiff(taxa_updated, taxa_initial)
cat("  New taxa discovered:", length(new_taxa), "\n")
if (length(new_taxa) > 0 && length(new_taxa) <= 30) {
cat("\n  New taxa list:\n")
cat(paste("   -", sort(new_taxa)), sep = "\n")
}
# Check for infraspecific taxa
has_infraspecific <- function(taxon_name) {
name_lower <- tolower(as.character(taxon_name))
grepl("subsp\\.|var\\.|f\\.", name_lower)
}
n_infra_initial <- sum(sapply(floristic_initial$Taxon, has_infraspecific))
n_infra_updated <- sum(sapply(floristic_updated$Taxon, has_infraspecific))
cat("\n  Records with infraspecific ranks (subsp/var):\n")
cat("    Initial:", n_infra_initial, "\n")
cat("    Updated:", n_infra_updated, "\n")
# ============================================================================
# VISUAL CHECK
# ============================================================================
# Identify new records
floristic_initial$record_id <- paste(
floristic_initial$Taxon,
round(floristic_initial$Lat, 6),
round(floristic_initial$Long, 6),
floristic_initial$year,
sep = "_"
)
floristic_updated$record_id <- paste(
floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year,
sep = "_"
)
new_records <- floristic_updated %>%
filter(!record_id %in% floristic_initial$record_id)
cat("\nNew records (not in baseline):", nrow(new_records), "\n")
cat("  From 2025:", sum(new_records$year == 2025), "\n")
cat("  From before 2025:", sum(new_records$year < 2025), "\n")
# Plot
plot(st_geometry(study_area), border = "black", lwd = 2,
main = "2025 Fieldwork - Standardized Nomenclature")
plot(st_geometry(floristic_initial), add = TRUE, col = "gray60", pch = 20, cex = 0.3)
plot(st_geometry(new_records), add = TRUE, col = "red", pch = 20, cex = 0.8)
legend("topright",
legend = c("Baseline (ante)", "New records (post)"),
col = c("gray60", "red"),
pch = 20,
pt.cex = c(0.3, 0.8))
# ============================================================================
# RUN MRFI COMPARISON
# ============================================================================
cat("\n=== RUNNING MRFI COMPARISON ===\n\n")
comparison_standardized <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_STANDARDIZED_NOMENCLATURE"
)
set.seed(123)
floristic_initial_subset <- floristic_initial[sample(nrow(floristic_initial),
size = floor(nrow(floristic_initial) * 0.25)), ]
floristic_updated_subset <- floristic_updated[sample(nrow(floristic_updated),
size = floor(nrow(floristic_updated) * 0.25)), ]
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial_subset,
data_flor_updated = floristic_updated_subset,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-OK"
)
source("~/R projects/ignobioR/R/compare_mrfi.R", echo = TRUE)
source("~/R projects/ignobioR/R/compare_mrfi.R", echo = TRUE)
set.seed(123)
floristic_initial_subset <- floristic_initial[sample(nrow(floristic_initial),
size = floor(nrow(floristic_initial) * 0.25)), ]
floristic_updated_subset <- floristic_updated[sample(nrow(floristic_updated),
size = floor(nrow(floristic_updated) * 0.25)), ]
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial_subset,
data_flor_updated = floristic_updated_subset,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-OK"
)
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-FULL"
)
library(sf)
library(dplyr)
# ============================================================================
# LOAD DATA WITH NEW STANDARDIZED NOMENCLATURE
# ============================================================================
# Baseline (before 2025 fieldwork)
floristic_ante_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/Progetti/MSRM/wiki parco/01_dec_2025-ante.shp")
# Updated (after 2025 fieldwork)
floristic_post_raw <- st_read("C:/Users/Giuseppe Antonelli/Documents/Progetti/MSRM/wiki parco/01_dec_2025-post_BIAS.shp")
# Study area (same as before)
study_area <- st_read("C:/Users/Giuseppe Antonelli/Documents/progetti/MSRM/test-na/confini-buffer125_finale.shp")
if (is.na(st_crs(study_area))) {
st_crs(study_area) <- 4326
}
# ============================================================================
# CLEAN AND RENAME WITH NEW COLUMN NAMES
# ============================================================================
clean_floristic_new <- function(data) {
data %>%
rename(
uncertainty = Accuratezz,
year = Anno.Reper,  # Note: might be Anno_Reper depending on shapefile
Lat = Lat.Wgs84,
Long = Lon.Wgs84,
Taxon = Combinatio
) %>%
filter(
!is.na(Taxon),
!is.na(Lat),
!is.na(Long),
!is.na(uncertainty),
!is.na(year)
)
}
# Check actual column names first
cat("Checking column names in ante file:\n")
print(names(floristic_ante_raw))
cat("\nChecking column names in post file:\n")
print(names(floristic_post_raw))
# Apply cleaning (adjust column names based on output above if needed)
floristic_initial <- clean_floristic_new(floristic_ante_raw)
floristic_updated <- clean_floristic_new(floristic_post_raw)
# ============================================================================
# SUMMARY OF STANDARDIZED DATA
# ============================================================================
cat("\n=== STANDARDIZED DATA SUMMARY ===\n\n")
cat("BASELINE (ante - before 2025):\n")
cat("  Total records:", nrow(floristic_initial), "\n")
cat("  Unique taxa:", length(unique(floristic_initial$Taxon)), "\n")
cat("  Year range:", range(floristic_initial$year), "\n\n")
cat("UPDATED (post - after 2025):\n")
cat("  Total records:", nrow(floristic_updated), "\n")
cat("  Unique taxa:", length(unique(floristic_updated$Taxon)), "\n")
cat("  Year range:", range(floristic_updated$year), "\n\n")
cat("CHANGES:\n")
cat("  New observations added:", nrow(floristic_updated) - nrow(floristic_initial), "\n")
# Check for truly new taxa
taxa_initial <- unique(floristic_initial$Taxon)
taxa_updated <- unique(floristic_updated$Taxon)
new_taxa <- setdiff(taxa_updated, taxa_initial)
cat("  New taxa discovered:", length(new_taxa), "\n")
if (length(new_taxa) > 0 && length(new_taxa) <= 30) {
cat("\n  New taxa list:\n")
cat(paste("   -", sort(new_taxa)), sep = "\n")
}
# Check for infraspecific taxa
has_infraspecific <- function(taxon_name) {
name_lower <- tolower(as.character(taxon_name))
grepl("subsp\\.|var\\.|f\\.", name_lower)
}
n_infra_initial <- sum(sapply(floristic_initial$Taxon, has_infraspecific))
n_infra_updated <- sum(sapply(floristic_updated$Taxon, has_infraspecific))
cat("\n  Records with infraspecific ranks (subsp/var):\n")
cat("    Initial:", n_infra_initial, "\n")
cat("    Updated:", n_infra_updated, "\n")
# ============================================================================
# VISUAL CHECK
# ============================================================================
# Identify new records
floristic_initial$record_id <- paste(
floristic_initial$Taxon,
round(floristic_initial$Lat, 6),
round(floristic_initial$Long, 6),
floristic_initial$year,
sep = "_"
)
floristic_updated$record_id <- paste(
floristic_updated$Taxon,
round(floristic_updated$Lat, 6),
round(floristic_updated$Long, 6),
floristic_updated$year,
sep = "_"
)
new_records <- floristic_updated %>%
filter(!record_id %in% floristic_initial$record_id)
cat("\nNew records (not in baseline):", nrow(new_records), "\n")
cat("  From 2025:", sum(new_records$year == 2025), "\n")
cat("  From before 2025:", sum(new_records$year < 2025), "\n")
# Plot
plot(st_geometry(study_area), border = "black", lwd = 2,
main = "2025 Fieldwork - Standardized Nomenclature")
plot(st_geometry(floristic_initial), add = TRUE, col = "gray60", pch = 20, cex = 0.3)
plot(st_geometry(new_records), add = TRUE, col = "red", pch = 20, cex = 0.8)
legend("topright",
legend = c("Baseline (ante)", "New records (post)"),
col = c("gray60", "red"),
pch = 20,
pt.cex = c(0.3, 0.8))
# ============================================================================
# RUN MRFI COMPARISON
# ============================================================================
cat("\n=== RUNNING MRFI COMPARISON ===\n\n")
comparison_standardized <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_STANDARDIZED_NOMENCLATURE"
)
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 20,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-FULL2"
)
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 20,
cellsize = 2000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-FULL2"
)
comparison_test <- compare_mrfi(
data_flor_initial = floristic_initial,
data_flor_updated = floristic_updated,
site = study_area,
tau = 40,
cellsize = 1000,
year_initial = max(floristic_initial_subset$year),
year_updated = 2025,
use_coverage_weighting = FALSE,
output_prefix = "MSRM_2025_TEST_QUADRANT-BIAS-FULL2"
)
source("~/R projects/ignobioR/R/taxon_raster_helpers.R", echo = TRUE)
devtools::clean_dll()
devtools::load_all()
source("~/R projects/ignobioR/R/ignorance_map.R", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
source("~/R projects/ignobioR/R/taxon_raster_helpers.R", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
devtools::clean_dll()
devtools::load_all()
source("~/R projects/ignobioR/R/ignorance_map.R", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
source("~/R projects/ignobioR/R/taxon_raster_helpers.R", echo = TRUE)
devtools::clean_dll()
devtools::load_all()
source("~/R projects/ignobioR/R/ignorance_map.R", echo = TRUE)
source("~/.active-rstudio-document", echo = TRUE)
source("~/R projects/ignobioR/R/taxon_raster_helpers.R", echo = TRUE)
devtools::clean_dll()
devtools::document()
devtools::install()
source("~/.active-rstudio-document", echo = TRUE)
